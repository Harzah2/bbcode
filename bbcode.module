<?php
// $Id$

// When configuration of which tags are allowed is implemented,
// the long help text should be made modular such that only the enabled
// tags have their corresponding help displayed.
function bbcode_help($section) {

  if ($section == "admin/system/modules#description") {
    return t("Use bbcode in your posts.");
  }
   
  elseif ($section == 'filter#short-tip') {
    return t("You can use <a href=\"%bbode_help\">BBCode tags</a> in the text, URLs will be automatically converted to links", array("%bbcode_help", url('filter/tips', NULL, 'filter-bbcode')));
  }
  
  elseif ($section == "filter#long-tip") {

    return t("<h1>BBCode Guide</h1>

<h2>Introduction</h2>

<p>
 BBCode allows you to specify formatting rules for your text,
 even if you are not allowed to use HTML in your posts. BBCode
 originated from the forum software named PHPBB, and Drupal has a
 special implementation of it.
</p>
<p>
 In BBCode terms, you use \"tags\" to add formatting to your text. Every
 tag is enclosed in [ and ]. If you want to mark some region in
 your text, you need to use an opening tag and a closing tag. Closing
 tags start with [/, as you will see in the examples below. If you
 mistype a tag or forget to close it, you will not get the desired
 formatting.
</p>

<h2>Simple text formatting</h2>

<p>
 BBCode allows you to make some parts of your texts stand out from the
 context by adding <strong>[b]</strong>old, <strong>[i]</strong>talic
 and <strong>[u]</strong>nderlined formatting to them. The
 <strong>[color]</strong> and <strong>[size]</strong> tags allow you to
 change the color and size of portions of the text you enclose with
 these tags. Both require a parameter (which colour or how big) that is
 suffixed to the name of the tag by an equals sign (example below).
 You should not repeat the parameter in the closing tag!
</p>

<p>
 You can specify any recognized color name (red, blue, green, white, etc.)
 or a hexadecimal color value (#CDCDCD, #FFFFFF, etc.) as the parameter of
 a <strong>[color]</strong> tag. The <strong>[size]</strong> tag allows you
 to set the font size between 10 and 30, 10 being the smallest size.
 Note that using very large text is considered by many to be annoying, and
 it is seldom a good idea to try to drive more attention to your post in
 this way.
</p>

<table>
 <tr>
  <th>usage</th><th>display</th>
 </tr>
 <tr>
  <td>I [b]need to do[/b] this by the weekend</td>
  <td>I <strong>need to do</strong> this by the weekend</td>
 </tr>
 <tr>
  <td>John said, that [i]we should[/i] ask her</td>
  <td>John said, that <em>we should</em> ask her</td>
 </tr>
 <tr>
  <td>I [u]would not like to[/u] offend you</td>
  <td>I <span style=\"text-decoration: underline;\">would not like to</span> offend you</td>
 </tr>
 <tr>
  <td>Jane was at [color=blue]the coast[/color]</td>
  <td>Jane was at <span style=\"color: blue;\">the coast</span></td>
 </tr>
 <tr>
  <td>Joe was in [color=#00FF00]the forest[/color]</td>
  <td>Joe was in <span style=\"color: #00FF00;\">the forest</span></td>
 </tr>
 <tr>
  <td>You said: [size=20]HEY![/size]</td>
  <td>You said: <span style=\"font-size: 20px;\">HEY!</span></td>
 </tr>
</table>

<h2>Creating Links</h2>

<p>
 You have multiple options to specify links to other destinations in
 your posts.
</p>

<p>
 Drupal recognizes URLs (Uniform Resource Locators) used in your posts, and
 automatically replaces them with links. For URLs starting with \"www\" or
 \"ftp\" (eg. www.example.com) there is no need for a protocol specification,
 but you need to specify a protocol for other types of addresses
 (eg. example.com).
</p>
<p>
 Drupal also recognizes email addresses in posts automatically, but for compatibility
 with the common BBCode implementations, also provides the <strong>[email]</strong> tag
 to mark email addresses. There is no spam protection applied to the email addresses!
</p>
<p>
 You can use the <strong>[url]</strong> tag with a parameter to specify a link with
 meaningful text to click on. If you use the url tag without the parameter,
 then the enclosed text is assumed to be an URL, and a link is created to that
 destination.
</p>

<table>
 <tr>
  <th>usage</th><th>display</th>
 </tr>
 <tr>
  <td>For more examples, visit www.example.com</td>
  <td>For more examples, visit <a href=\"http://www.example.com\" target=\"_blank\">www.example.com</a></td>
 </tr>
 <tr>
  <td>For more examples, visit http://example.com</td>
  <td>For more examples, visit <a href=\"http://example.com\" target=\"_blank\">http://example.com</a></td>
 </tr>
 <tr>
  <td>If you have questions ask me at joe@example.com</td>
  <td>If you have questions ask me at <a href=\"mailto:joe@example.com\">joe@example.com</a></td>
 </tr>
 <tr>
  <td>If you have questions ask me at [email]joe@example.com[/email]</td>
  <td>If you have questions ask me at <a href=\"mailto:joe@example.com\">joe@example.com</a></td>
 </tr>
 <tr>
  <td>We use [url=http://example.com/]the example site[/url] in these examples</td>
  <td>We use <a href=\"http://example.com/\" target=\"_blank\">the example site</a> in these examples</td>
 </tr>
 <tr>
  <td>We use [url]http://example.com/[/url] in these examples</td>
  <td>We use <a href=\"http://example.com/\" target=\"_blank\">http://example.com/</a> in these examples</td>
 </tr>
</table>

<h2>Displaying images</h2>

<p>
 The <strong>[img]</strong> tag allows you to display an image in your
 post. You need to specify a URL to the image, so it needs to be
 accessible somewhere on the internet. Beware of adding very large
 images to your text, or otherwise the page will load very slowly!
</p>

<p>
 If you enclose a URL in an <strong>[img]</strong> tag, then it will
 be replaced with code to display the image. For example <code>A good
 screenshot: [img]http://example.com/screenshot.png[/img]</code>
 will show you the screenshot (if it exists). 
</p>
<p>
 You can also specify the desired display dimensions of the image by
 adding a dimension parameter to the <strong>[img]</strong> tag. <code>A
 good screenshot: [img=640x480]http://example.com/screenshot.png[/img]</code>
 will display the image in 640x480 (though the full image will be
 downloaded). Do not use this to show a thumbnail of an image!
</p>

<p>
 You are free to link an image to an external destination by enclosing
 the <strong>[img]</strong> tag with an <strong>[url]</strong> tag: <code>See
 [url=http://example.com][img]http://example.com/screenshot.png[/img][/url]</code>.
</p>

<h2>Ordered and unordered lists</h2>

<p>
 The simplest list type is the unordered list, which means that there is
 no numbering applied to the elements. You can make such a list by enclosing
 the list elements in <strong>[list]</strong> opening and closing tags.
 Specify the start of one element with the <strong>[*]</strong> list element
 marker, which has no closing tag pair.
</p>

<p>
 To create an ordered list, you should add a parameter to the [list]
 list tag specifying what type of ordered list you would like to see.
 The possible parameters are \"i\", \"I\", \"1\", \"a\", and \"A\" which all
 correspond to the display of the first list element.
</p>

<table>
 <tr>
  <th>usage</th><th>display</th>
 </tr>
 <tr>
  <td><pre>
I love
 [list]
  [*]Oranges
  [*]Apples
  [*]Bananas
 [/list]
</pre></td>
  <td>
   I love 
   <ul>
    <li>Oranges</li>
    <li>Apples</li>
    <li>Bananas</li>
   </ul>
  </td>
 </tr>
 <tr>
  <td><pre>
I love
 [list=I]
  [*]Oranges
  [*]Apples
  [*]Bananas
 [/list]
</pre></td>
  <td>
   I love 
   <ol style=\"list-style-type: upper-roman;\">
    <li>Oranges</li>
    <li>Apples</li>
    <li>Bananas</li>
   </ol>
  </td>
 </tr>
 <tr>
  <td><pre>
I love
 [list=1]
  [*]Oranges
  [*]Apples
  [*]Bananas
 [/list]
</pre></td>
  <td>
   I love 
   <ol style=\"list-style-type: decimal;\">
    <li>Oranges</li>
    <li>Apples</li>
    <li>Bananas</li>
   </ol>
  </td>
 </tr>
</table>

<h2>Fixed-width text and block formatting</h2>

<p>
 You can use the <strong>[code]</strong> tag to add an inline fixed-width
 formatted part or to add a block of (usually program) code. If there is
 any newline present between the opening and closing tags, then a block
 will be displayed.
</p>

<table>
 <tr>
  <th>usage</th><th>display</th>
 </tr>
 <tr>
  <td>Edit your [code]robots.txt[/code] file</td>
  <td>Edit your <code>robots.txt</code> file</td>
  </td>
 </tr>
 <tr>
  <td>
An HTML title example:<br />
[code]<br />
&lt;head&gt;<br />
&nbsp;&lt;title&gt;Page Title&lt;/title&gt;<br />
&lt;/head&gt;<br />
[/code]
  </td>
  <td>
An HTML title example:<br />
<div class=\"codeblock\"><code>
&lt;head&gt;<br />
&nbsp;&lt;title&gt;Page Title&lt;/title&gt;<br />
&lt;/head&gt;<br />
</code>
  </td>
 </tr>
</table>

<h2>Using multiple formatting tags</h2>

<p>
 You can apply more than one formatting specification to a portion of some
 text. <code>I was at [b][i]the coast[/i][/b]</code> will be
 rendered as <code>I was at <strong><em>the coast</em></strong></code> for
 example.
</p>

<p>
 Make sure that you take care of the proper order of the opening and closing
 tags. You should close the tags in the opposite order in which you opened
 them. Otherwise you might get very strange rendering results. Also check
 your post with the preview function before submiting it to discover possible
 formatting errors due to improper BBCode usage.
</p>

<p>
 There are some exceptions where you cannot add more BBCode tags. Examples
 of these include the contents of the <strong>[img]</strong> tag, which by
 definition should contain an URL only. BBCode tags are also disallowed
 inside <strong>[code]</strong> tags, and you cannot apply some formatting
 to all list items by wrapping the list with that formatting tag.
</p>");
  }
}

function bbcode_filter($body) {
  
  $quote_text = t('Quote');
  $quote_user = t('Quote \\1');

  $preg = array(
    
    // Font, text and alignment
    '#\[color=(.*?)(?::\w+)?\](.*?)\[/color(?::\w+)?\]#si'   => '<span style="color:\\1">\\2</span>',
    '#\[size=(.*?)(?::\w+)?\](.*?)\[/size(?::\w+)?\]#si'     => '<span style="font-size:\\1">\\2</span>',
    '#\[font=(.*?)(?::\w+)?\](.*?)\[/font(?::\w+)?\]#si'     => '<span style="font-family:\\1">\\2</span>',
    '#\[align=(.*?)(?::\w+)?\](.*?)\[/align(?::\w+)?\]#si'   => '<div style="text-align:\\1">\\2</div>',
    '#\[float=(.*?)(?::\w+)?\](.*?)\[/float(?::\w+)?\]#si'   => '<div style="float:\\1">\\2</div>',
    '#\[b(?::\w+)?\](.*?)\[/b(?::\w+)?\]#si'                 => '<b>\\1</b>',
    '#\[i(?::\w+)?\](.*?)\[/i(?::\w+)?\]#si'                 => '<i>\\1</i>',
    '#\[u(?::\w+)?\](.*?)\[/u(?::\w+)?\]#si'                 => '<u>\\1</u>',
    '#\[center(?::\w+)?\](.*?)\[/center(?::\w+)?\]#si'       => '<div style="text-align:center">\\1</div>',
    '#\[left(?::\w+)?\](.*?)\[/left(?::\w+)?\]#si'           => '<div style="text-align:left">\\1</div>',
    '#\[right(?::\w+)?\](.*?)\[/right(?::\w+)?\]#si'         => '<div style="text-align:right">\\1</div>',
    
    // Email addresses without and with good looking text
    '#\[email(?::\w+)?\](.*?)\[/email(?::\w+)?\]#si'         => '<a href="mailto:\\1" class="bb_email">\\1</a>',
    '#\[email=(.*?)(?::\w+)?\](.*?)\[/email(?::\w+)?\]#si'   => '<a href="mailto:\\1" class="bb_email">\\2</a>',
    
    // Links without a protocol, with a protocol and with good looking text
    '#\[url(?::\w+)?\]www\.(.*?)\[/url(?::\w+)?\]#si'        => '<a href="http://www.\\1" class="bb_url">\\1</a>',
    '#\[url(?::\w+)?\](.*?)\[/url(?::\w+)?\]#si'             => '<a href="\\1" class="bb_url">\\1</a>',
    '#\[url=(.*?)(?::\w+)?\](.*?)\[/url(?::\w+)?\]#si'       => '<a href="\\1" class="bb_url">\\2</a>',
    
    // Images without or with client-side sizing
    '#\[img(?::\w+)?\](.*?)\[/img(?::\w+)?\]#si'             => '<img src="\\1" class="bb_image" />',
    '#\[img=(.*?)x(.*?)(?::\w+)?\](.*?)\[/img(?::\w+)?\]#si' => '<img width="\\1" height="\\2" src="\\3" class="bb_image" />',
    
    // Quoting with or without specifying the source
    '#\[quote(?::\w+)?\](?:[\r\n])*(.*?)\[/quote(?::\w+)?\]#si'         => '<div class="bb_quote">'.$quote_text.':<div class="bb_quote_body">\\1</div></div>',
    '#\[quote=(?:&quot;|"|\')?(.*?)["\']?(?:&quot;|"|\')?\](?:[\r\n])*(.*?)\[/quote(?::\w+)?\]#si'   => '<div class="bb_quote">'.$quote_user.':<div class="bb_quote_body">\\2</div></div>',
    
    // Different kinds of lists and list items
    '#\[\*(?::\w+)?\]\s*([^\[]*)#si'                         => '<li>\\1</li>',
    '#\[list(?::\w+)?\](.*?)\[/list(?::\w+)?\]#si'           => _bbcode_list_tag(),
    '#\[list(?::\w+)?\](.*?)\[/list:u(?::\w+)?\]#s'          => _bbcode_list_tag(),
    '#\[list(?::\w+)?\](.*?)\[/list:o(?::\w+)?\]#s'          => _bbcode_list_tag('decimal'),
    '#\[list=1(?::\w+)?\](.*?)\[/list(?::\w+)?\]#si'         => _bbcode_list_tag('decimal'),
    '#\[list=i(?::\w+)?\](.*?)\[/list(?::\w+)?\]#s'          => _bbcode_list_tag('lower-roman'),
    '#\[list=I(?::\w+)?\](.*?)\[/list(?::\w+)?\]#s'          => _bbcode_list_tag('upper-roman'),
    '#\[list=a(?::\w+)?\](.*?)\[/list(?::\w+)?\]#s'          => _bbcode_list_tag('lower-alpha'),
    '#\[list=A(?::\w+)?\](.*?)\[/list(?::\w+)?\]#s'          => _bbcode_list_tag('upper-alpha'),
    
    // Clean up the list output a bit
    '#<ol(.*?)>(?:.*?)<li(.*?)>#si'         => '<ol\\1><li\\2>',
    '#<ul(.*?)>(?:.*?)<li(.*?)>#si'         => '<ul\\1><li\\2>'
  );
  $body = preg_replace(array_keys($preg), array_values($preg), $body);
  
  // Horizontal delimiter
  $body = str_replace("[hr]", '<hr class="bb_hr" />', $body);

  // Find all [code] tags and check if they contain a newline. In case we find a newline,
  // that [code] should be rendered as a block, otherwise it will still be inline
  if (preg_match_all('#\[code(?::\w+)?\](.*?)\[/code(?::\w+)?\]#si', $body, $code_tags, PREG_SET_ORDER)) {
      foreach ($code_tags as $code_tag) {
          if (strpos($code_tag[1], "\n") !== FALSE) {
              $code_tag[1] = str_replace(array("\n ", "  "), array("\n&nbsp;", " &nbsp;"), $code_tag[1]);
              $code_block = '<div class="bb_code_block">%s</div>';
          } else {
              $code_block = '<code class="bb_code">%s</code>';
          }
          $body = str_replace($code_tag[0], sprintf($code_block, trim($code_tag[1])), $body);
      }
  }
  
  /**
   * - Goes through the given string, and replaces xxxx://yyyy with an HTML <a> tag linking
   *  to that URL
   * - Goes through the given string, and replaces www.xxxx.yyyy[zzzz] with an HTML <a> tag linking
   *  to http://www.xxxx.yyyy[/zzzz]
   * - Goes through the given string, and replaces xxxx@yyyy with an HTML mailto: tag linking
   *    to that email address
   * - Only matches these 2 patterns either after a space, or at the beginning of a line
   *
   * Notes: the email one might get annoying - it's easy to make it more restrictive, though.. maybe
   * have it require something like xxxx@yyyy.zzzz or such. We'll see.
   */

  // pad it with a space so we can match things at the start of the 1st line.
  $ret = ' ' . $body;

  // matches an "xxxx://yyyy" URL at the start of a line, or after a space.
  // xxxx can only be alpha characters.
  // yyyy is anything up to the first space, newline, comma, double quote or <
  $ret = preg_replace("#([\t\r\n ])([a-z0-9]+?){1}://([\w\-]+\.([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^ \"\n\r\t<]*)?)#i", '\1<a href="\2://\3">\2://\3</a>', $ret);

  // matches a "www|ftp.xxxx.yyyy[/zzzz]" kinda lazy URL thing
  // Must contain at least 2 dots. xxxx contains either alphanum, or "-"
  // zzzz is optional.. will contain everything up to the first space, newline,
  // comma, double quote or <.
  $ret = preg_replace("#([\t\r\n ])(www|ftp)\.(([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^ \"\n\r\t<]*)?)#i", '\1<a href="http://\2.\3">\2.\3</a>', $ret);

  // matches an email@domain type address at the start of a line, or after a space.
  // Note: Only the followed chars are valid; alphanums, "-", "_" and or ".".
  $ret = preg_replace("#([\n ])([a-z0-9\-_.]+?)@([\w\-]+\.([\w\-\.]+\.)*[\w]+)#i", "\\1<a href=\"mailto:\\2@\\3\">\\2@\\3</a>", $ret);

  // Remove our padding..
  $ret = substr($ret, 1);

  return $ret;
}

function _bbcode_list_tag($type = NULL) {
  if (isset($type)) {
    return '<ol class="bb_list" style="list-style-type:' . $type . ';">\\1</ol>';
  }
  else {
    return '<ul class="bb_list">\\1</ul>';
  }
}

function bbcode_conf_filters() {
  return form_group(t("BBCode filter"), t("The bbcode filter is enabled. You can get more information about the possible formatting rules on the <a href=\"%filter_tips\">Compose Tips</a> page.", array("%filter_tips" => url("filter/tips", NULL, 'filter-bbcode'))));
}

?>
