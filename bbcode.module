<?php
// $Id$

function bbcode_help($section) {
  if ($section == "admin/modules#description")
    return t("Allow the use of BBCode in your posts.");
}

function bbcode_filter_tips($delta, $format, $long = false) {
  if ($long) {
    include_once 'bbcode-help.inc';
    return _bbcode_filter_tip();
  }
  else 
    return t("You can use <a href=\"%bbcode_help\">BBCode tags</a> in the text, URLs will be automatically converted to links", array("%bbcode_help" => url("filter/tips/$format", NULL, 'filter-bbcode')));
}

function bbcode_filter($op, $delta = 0, $format = -1, $text = '') {
  switch ($op) {
    case 'list':
      return array(0 => t('BBCode'));

    case 'description':
      return t('Converts BBCode to HTML.');

    case 'process':
      include_once 'bbcode-filter.inc';
      if (variable_get("bbcode_debug", 0)) {
        $timing_start = explode(' ', microtime());
        $ret = _bbcode_filter_process($text, $format);
        $timing_stop = explode(' ', microtime());
        $elapsed = $timing_stop[1] - $timing_start[1];
        $elapsed += $timing_stop[0] - $timing_start[0];
        $ret .= '<hr /><a href="http://drupal.org/project/bbcode">BBCode</a> parsed on '.date('r').'<br />Execution time: '.$elapsed.' seconds.<hr />';
        return $ret;
      }
      else 
        return _bbcode_filter_process($text, $format);

    case 'settings':
      $form = array();
      $form['bbcode_filter'] = array(
        '#type' => 'fieldset', 
        '#title' => t('BBCode filter'), 
        '#collapsible' => TRUE, 
        '#collapsed' => TRUE);
      $form['bbcode_filter']["bbcode_encode_mailto_$format"] = array(
        '#type' => 'select', 
        '#title' => t('Email address encoding'), 
        '#default_value' => variable_get("bbcode_encode_mailto_$format", 1), 
        '#options' => array(t("Disabled"), t("Enabled")), 
        '#description' => t('Whether to encode email addresses with javascript. With this method you will have clickable mailto links, but it will be a bit harder for spam robots to collect them.'));
      $form['bbcode_filter']["bbcode_paragraph_breaks"] = array(
        '#type' => 'select',
        '#title' => t('Smart paragraph and line breaks'),
        '#default_value' => variable_get("bbcode_paragraph_breaks", 2),
        '#options' => array(t("Disabled"), t("Line breaks only"), t("Line and paragraph breaks")),
        '#description' => t('Add line and paragraph breaks to text, excluding text in preformatted code blocks. If you disable this option, you need to enable Drupal\'s "Line break converter". Don\'t use both together!'));
      $form['bbcode_filter']["bbcode_debug"] = array(
        '#type' => 'select', 
        '#title' => t('Print debugging info'), 
        '#default_value' => variable_get("bbcode_debug", 0), 
        '#options' => array(t("Disabled"), t("Enabled")), 
        '#description' => t('Print BBCode parse date and execution time. This option should never be enabled on production sites. You may want to clear the cache after changing this option.'));
      return $form;

    default:
      return $text;
  }
}
